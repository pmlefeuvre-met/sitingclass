<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Classification of landtypes • sitingclass</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Classification of landtypes">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sitingclass</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/classification_landtype.html">Classification of landtypes</a></li>
    <li><a class="dropdown-item" href="../articles/getting_started.html">Getting started with sitingclass</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://gitlab.met.no/pierreml/sitingclass/" aria-label="GitLab"><span class="fa fab fa-gitlab fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Classification of landtypes</h1>
                        <h4 data-toc-skip class="author">Pierre-Marie
Lefeuvre</h4>
            
            <h4 data-toc-skip class="date">2025-02-11</h4>
      
      <small class="dont-index">Source: <a href="https://gitlab.met.no/pierreml/sitingclass/blob/HEAD/vignettes/classification_landtype.Rmd" class="external-link"><code>vignettes/classification_landtype.Rmd</code></a></small>
      <div class="d-none name"><code>classification_landtype.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="classification-of-artificial-and-vegetation-landtypes">Classification of artificial and vegetation landtypes<a class="anchor" aria-label="anchor" href="#classification-of-artificial-and-vegetation-landtypes"></a>
</h2>
<p>Following the WMO</p>
<p>Sources: - Temperature siting classification in Nordic Countries from
<a href="https://www.met.no/publikasjoner/met-report/met-report-2016" class="external-link">Met’s
2016 reports</a></p>
</div>
<div class="section level2">
<h2 id="sitingclass">
<code>sitingclass</code><a class="anchor" aria-label="anchor" href="#sitingclass"></a>
</h2>
<div class="section level3">
<h3 id="compute-landtype">Compute landtype<a class="anchor" aria-label="anchor" href="#compute-landtype"></a>
</h3>
<div class="section level4">
<h4 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h4>
<p>Running the function for a station is as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load library</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gitlab.met.no/pierreml/sitingclass" class="external-link">sitingclass</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/" class="external-link">tidyterra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get station metadata</span></span>
<span><span class="va">stn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_metadata_frost.html">get_metadata_frost</a></span><span class="op">(</span>stationid <span class="op">=</span> <span class="fl">18700</span>, dx <span class="op">=</span> <span class="fl">100</span>, resx <span class="op">=</span> <span class="fl">1</span>, path <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] " "
[1] "-------------------------------------------"
[1] "station MET.NO: 18700 -- OSLO - BLINDERN -- Fast_IP: 10.240.10.11:6785"
[2] "station MET.NO: 18700 -- OSLO - BLINDERN -- Fast_IP: 10.240.10.11:6785"
[3] "station MET.NO: 18700 -- OSLO - BLINDERN -- WMO: 0-20000-0-01492"      
[4] "station MET.NO: 18700 -- OSLO - BLINDERN -- WIGOS: 0-20000-0-01492"    
[1] "-------------------------------------------"
[1] " "</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute land cover</span></span>
<span><span class="va">landtype_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_landtype.html">compute_landtype</a></span><span class="op">(</span><span class="va">stn</span>, f_plot<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "Process: 18700 - 260966.8/6652718.0 - dtm - 100/1 - path: data/dem"
[1] "Process: 18700 - 260966.8/6652718.0 - dom - 100/1 - path: data/dem"</code></pre>
<div class="figure" style="text-align: center">
<img src="classification_landtype_files/figure-html/setup-1.png" alt="center" width="50%"><p class="caption">
center
</p>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landtype_out</span></span></code></pre></div>
<pre><code> class       : SpatVector 
 geometry    : polygons 
 dimensions  : 7, 1  (geometries, attributes)
 extent      : 260865.8, 261067.2, 6652618, 6652819  (xmin, xmax, ymin, ymax)
 coord. ref. : ETRS89 / UTM zone 33N (EPSG:25833) 
 names       : landtype
 type        :   &lt;fact&gt;
 values      :     tree
                   bush
                   crop</code></pre>
</div>
<div class="section level4">
<h4 id="in-details">In details<a class="anchor" aria-label="anchor" href="#in-details"></a>
</h4>
<p>The area of reference or bounding box is set using
<code>make_bbox(stn)</code> but the square bbox is reset using the DEM’s
area after their difference to accommodate for some marginal geometrical
differences such as +/- 1 meter caused by a shift in the reference
corner during the data download and after rounding the station
coordinates.</p>
<p>Eventually, the dimension of the returned DEM difference is extracted
(i.e. the number of pixel) as it sets the image resolution that I will
obtain from the WMS query in the next part.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Construct box to extract WMS tile</span></span>
<span><span class="va">box</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_bbox.html">make_bbox</a></span><span class="op">(</span><span class="va">stn</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download DEMs</span></span>
<span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_dem_kartverket.html">download_dem_kartverket</a></span><span class="op">(</span><span class="va">stn</span>, name <span class="op">=</span> <span class="st">"dtm"</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "Process: 18700 - 260966.8/6652718.0 - dtm - 100/1 - path: data/dem"
[1] "Load existing file: data/dem/18700_dtm_25833_d00100m_1.0m.tif"</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_dem_kartverket.html">download_dem_kartverket</a></span><span class="op">(</span><span class="va">stn</span>, name <span class="op">=</span> <span class="st">"dom"</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "Process: 18700 - 260966.8/6652718.0 - dom - 100/1 - path: data/dem"
[1] "Load existing file: data/dem/18700_dom_25833_d00100m_1.0m.tif"</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Verify extent match</span></span>
<span><span class="kw">if</span><span class="op">(</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="op">!=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">dsm</span><span class="op">)</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"!! Mismatched extent !!"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">dsm</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Reload DEMs</span></span>
<span>  <span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_dem_kartverket.html">download_dem_kartverket</a></span><span class="op">(</span><span class="va">stn</span>, name <span class="op">=</span> <span class="st">"dtm"</span>, f_overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">dsm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_dem_kartverket.html">download_dem_kartverket</a></span><span class="op">(</span><span class="va">stn</span>, name <span class="op">=</span> <span class="st">"dom"</span>, f_overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute difference to assess vegetation</span></span>
<span><span class="va">dh</span>  <span class="op">&lt;-</span> <span class="va">dsm</span> <span class="op">-</span> <span class="va">dem</span></span>
<span></span>
<span><span class="co"># The number of pixels to extract from the WMS</span></span>
<span><span class="va">px</span>    <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">dh</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="co">#*4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Pixel number: %i"</span>, <span class="va">px</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "Pixel number: 201"</code></pre>
<p>Three specific layers are extracted from the FellesKartDatabase (FKB)
maintained by Kartverket on their geonorge.no servers. The FKB registers
buildings, roads and water bodies for official usage. Access to the
vector version of these layers is restricted, therefore the vectors are
recreated from the images they provide in their WMS distribution
service.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load FKB-AR5 tiles</span></span>
<span><span class="va">building</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_tile_wms.html">get_tile_wms</a></span><span class="op">(</span><span class="va">box</span>, layer <span class="op">=</span> <span class="st">"bygning"</span>, px <span class="op">=</span> <span class="va">px</span><span class="op">)</span></span>
<span><span class="va">road</span>      <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_tile_wms.html">get_tile_wms</a></span><span class="op">(</span><span class="va">box</span>, layer <span class="op">=</span> <span class="st">"fkb_samferdsel"</span>, px <span class="op">=</span> <span class="va">px</span><span class="op">)</span></span>
<span><span class="va">water</span>     <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_tile_wms.html">get_tile_wms</a></span><span class="op">(</span><span class="va">box</span>, layer <span class="op">=</span> <span class="st">"fkb_vann"</span>, px <span class="op">=</span> <span class="va">px</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster_rgb.html" class="external-link">geom_spatraster_rgb</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">building</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster_rgb.html" class="external-link">geom_spatraster_rgb</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">road</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">g3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster_rgb.html" class="external-link">geom_spatraster_rgb</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">water</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load complete/original FKB data </span></span>
<span><span class="va">fkb</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_tile_wms.html">get_tile_wms</a></span><span class="op">(</span><span class="va">box</span>, layer <span class="op">=</span> <span class="st">"fkb"</span>, px <span class="op">=</span> <span class="va">px</span><span class="op">)</span></span>
<span><span class="va">g0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster_rgb.html" class="external-link">geom_spatraster_rgb</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fkb</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">g0</span> <span class="op">+</span> <span class="va">g1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">g2</span> <span class="op">+</span> <span class="va">g3</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="classification_landtype_files/figure-html/unnamed-chunk-2-1.png" alt="center" width="50%"><p class="caption">
center
</p>
</div>
<p>The images are then: - converted from rasters to vector using
<code>as.polygons()</code>, - the white background vectors that have a
value of 255 are removed, - the vectors are then given a unique
identifier here <code>id = "building"</code>, - the vectors are smoothed
with a buffer of 1/4th the resolution of the raster, so 0.25 m as the
default resolution for the raster is 1 m, - the vectors are then
aggregated into one layer, - and plotted Finally all artificial land
vectors are combined into one as shown in the final plot.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert raster tile to vector landcover</span></span>
<span><span class="va">v_building</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/raster_to_vector.html">raster_to_vector</a></span><span class="op">(</span><span class="va">building</span>,</span>
<span>                               id <span class="op">=</span> <span class="st">"building"</span>,</span>
<span>                               mask_thr <span class="op">=</span> <span class="fl">255</span><span class="op">)</span></span>
<span><span class="va">v_road</span>     <span class="op">&lt;-</span> <span class="fu"><a href="../reference/raster_to_vector.html">raster_to_vector</a></span><span class="op">(</span><span class="va">road</span>,</span>
<span>                               id <span class="op">=</span> <span class="st">"road"</span>,</span>
<span>                               mask_thr <span class="op">=</span> <span class="fl">255</span><span class="op">)</span></span>
<span><span class="va">v_water</span>    <span class="op">&lt;-</span> <span class="fu"><a href="../reference/raster_to_vector.html">raster_to_vector</a></span><span class="op">(</span><span class="va">water</span>,</span>
<span>                               id <span class="op">=</span> <span class="st">"water"</span>,</span>
<span>                               mask_thr <span class="op">=</span> <span class="fl">255</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine and plot</span></span>
<span><span class="va">landtype_artificial</span> <span class="op">&lt;-</span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">v_building</span>, <span class="va">v_road</span>, <span class="va">v_water</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">landtype_artificial</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="classification_landtype_files/figure-html/unnamed-chunk-3-1.png" alt="center" width="50%"><p class="caption">
center
</p>
</div>
<p>To retrieve the vegetation height and its land cover, the DEM
difference <code>dh</code> is used, but first the artificial area are
masked out.</p>
<p>To the masked difference <code>dh_mask</code>, a height threshold is
applied following WMO’s recommendation: - grass: below or equal 10 cm -
crop: between 10 cm and 25 cm - bush: between 25 cm and 3 m - tree:
above and equal to 3 m</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Mask already identified land cover</span></span>
<span><span class="va">dh_mask</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">dh</span>,</span>
<span>                       <span class="va">landtype_artificial</span>,</span>
<span>                       inverse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                       touches <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Classify vegetation based on dh thresholds in metre</span></span>
<span><span class="va">v_grass</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/raster_to_vector.html">raster_to_vector</a></span><span class="op">(</span><span class="va">dh_mask</span> <span class="op">&lt;=</span> <span class="fl">.10</span>,</span>
<span>                            id <span class="op">=</span> <span class="st">"grass"</span>,</span>
<span>                            mask_thr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">v_crop</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/raster_to_vector.html">raster_to_vector</a></span><span class="op">(</span><span class="op">(</span><span class="va">dh_mask</span> <span class="op">&gt;</span> <span class="fl">.10</span> <span class="op">&amp;</span> <span class="va">dh_mask</span> <span class="op">&lt;=</span> <span class="fl">.25</span><span class="op">)</span>,</span>
<span>                            id <span class="op">=</span> <span class="st">"crop"</span>,</span>
<span>                            mask_thr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">v_bush</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/raster_to_vector.html">raster_to_vector</a></span><span class="op">(</span><span class="op">(</span><span class="va">dh_mask</span> <span class="op">&gt;</span> <span class="fl">.25</span> <span class="op">&amp;</span> <span class="va">dh_mask</span> <span class="op">&lt;=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>                            id <span class="op">=</span> <span class="st">"bush"</span>,</span>
<span>                            mask_thr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">v_tree</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/raster_to_vector.html">raster_to_vector</a></span><span class="op">(</span><span class="va">dh_mask</span> <span class="op">&gt;=</span> <span class="fl">3</span>,</span>
<span>                            id <span class="op">=</span> <span class="st">"tree"</span>,</span>
<span>                            mask_thr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Some work is still required to merge properly the layers together to
avoid for instance overlap. After having set each layer a factor level
with its name as a label, the overlaps are removed with the priority
order set by the order of the factors/levels, such as: 1. “building” 2.
“road” 3. “water” 4. “grass” 5. “crop” 6. “bush” 7. “tree”</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Merge all landcover vectors</span></span>
<span><span class="va">landtype</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">landtype_artificial</span>,</span>
<span>                          <span class="va">v_grass</span>,</span>
<span>                          <span class="va">v_crop</span>,</span>
<span>                          <span class="va">v_bush</span>,</span>
<span>                          <span class="va">v_tree</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert landcover type values to factors</span></span>
<span><span class="va">levels</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"building"</span>, <span class="st">"road"</span>, <span class="st">"water"</span>, <span class="st">"grass"</span>, <span class="st">"crop"</span>, <span class="st">"bush"</span>, <span class="st">"tree"</span><span class="op">)</span></span>
<span><span class="va">landtype</span><span class="op">$</span><span class="va">landtype</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">landtype</span><span class="op">$</span><span class="va">value</span>, levels <span class="op">=</span> <span class="va">levels</span><span class="op">)</span></span>
<span><span class="va">landtype</span> <span class="op">&lt;-</span> <span class="va">landtype</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Erase overlapping vectors with hierarchy defined by the order of levels</span></span>
<span><span class="va">landtype</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/erase.html" class="external-link">erase</a></span><span class="op">(</span><span class="va">landtype</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">landtype</span><span class="op">$</span><span class="va">landtype</span>,</span>
<span>                                        decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="op">]</span>,</span>
<span>                         sequential <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="output">Output<a class="anchor" aria-label="anchor" href="#output"></a>
</h4>
<p>A raster with the landcover nicely patched together ready to
analyse.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">landtype</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">landtype</span><span class="op">)</span>,</span>
<span>                             linewidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">fill_landtype</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>datum <span class="op">=</span> <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/pull_crs.html" class="external-link">pull_crs</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="classification_landtype_files/figure-html/unnamed-chunk-6-1.png" alt="center" width="50%"><p class="caption">
center
</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="compute-landtype_distance">Compute landtype_distance<a class="anchor" aria-label="anchor" href="#compute-landtype_distance"></a>
</h3>
<div class="section level4">
<h4 id="getting-started-1">Getting started<a class="anchor" aria-label="anchor" href="#getting-started-1"></a>
</h4>
<p>Running the function for a station is as follows:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute land type distance to station</span></span>
<span><span class="va">landtype_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_landtype_distance.html">compute_landtype_distance</a></span><span class="op">(</span><span class="va">stn</span>, <span class="va">landtype_out</span>, f_plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "Process: 18700 - 260966.8/6652718.0 - dtm - 100/1 - path: data/dem"
[1] "Load existing file: data/dem/18700_dtm_25833_d00100m_1.0m.tif"</code></pre>
<div class="figure" style="text-align: center">
<img src="classification_landtype_files/figure-html/unnamed-chunk-7-1.png" alt="center" width="50%"><p class="caption">
center
</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="compute-class">Compute class<a class="anchor" aria-label="anchor" href="#compute-class"></a>
</h3>
<div class="section level4">
<h4 id="getting-started-2">Getting started<a class="anchor" aria-label="anchor" href="#getting-started-2"></a>
</h4>
<p>Running the function for a station is as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load a digital elevation model</span></span>
<span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_dem_kartverket.html">download_dem_kartverket</a></span><span class="op">(</span><span class="va">stn</span>, name <span class="op">=</span> <span class="st">"dtm"</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "Process: 18700 - 260966.8/6652718.0 - dtm - 100/1 - path: data/dem"
[1] "Load existing file: data/dem/18700_dtm_25833_d00100m_1.0m.tif"</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute maximum horizon</span></span>
<span><span class="va">horizon_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_horizon_max.html">compute_horizon_max</a></span><span class="op">(</span><span class="va">stn</span>,</span>
<span>                                   step <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "Process: 18700 - 260966.8/6652718.0 - dtm - 100/1 - path: data/dem"
[1] "Load existing file: data/dem/18700_dtm_25833_d00100m_1.0m.tif"
[1] "Process: 18700 - 260966.8/6652718.0 - dom - 100/1 - path: data/dem"
[1] "Load existing file: data/dem/18700_dom_25833_d00100m_1.0m.tif"
[1] "Process: 18700 - 260966.8/6652718.0 - dtm - 20000/20 - path: data/dem"
Over-riding projection check
Importing raster map &lt;elev&gt;...
   0%   3%   6%   9%  12%  15%  18%  21%  24%  27%  30%  33%  36%  39%  42%  45%  48%  51%  54%  57%  60%  63%  66%  69%  72%  75%  78%  81%  84%  87%  90%  93%  96%  99% 100%</code></pre>
<pre><code>Over-riding projection check
Importing raster map &lt;elev&gt;...
   0%   3%   6%   9%  12%  15%  18%  21%  24%  27%  30%  33%  36%  39%  42%  45%  48%  51%  54%  57%  60%  63%  66%  69%  72%  75%  78%  81%  84%  87%  90%  93%  96%  99% 100%</code></pre>
<pre><code>Over-riding projection check
Importing raster map &lt;elev&gt;...
   0%   3%   6%   9%  12%  15%  18%  21%  24%  27%  30%  33%  36%  39%  42%  45%  48%  51%  54%  57%  60%  63%  66%  69%  72%  75%  78%  81%  84%  87%  90%  93%  96%  99% 100%</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute class</span></span>
<span><span class="va">class</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_class_air_temperature.html">compute_class_air_temperature</a></span><span class="op">(</span><span class="va">stn</span>,</span>
<span>                                       <span class="va">landtype_dist</span>,</span>
<span>                                       <span class="va">horizon_max</span>,</span>
<span>                                       <span class="va">dem</span>,</span>
<span>                                       test_type <span class="op">=</span> <span class="st">"WMO"</span>,</span>
<span>                                       f_plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="classification_landtype_files/figure-html/unnamed-chunk-8-1.png" alt="center" width="50%"><p class="caption">
center
</p>
</div>
<pre><code>[1] " "
[1] "-------------------------------------------"
     class_slope class_vegetation   class_landtype      class_shade 
        "class1"         "class1"         "class4"         "class5" 
[1] "-------------------------------------------"
[1] "-------------------------------------------"
[1] " "
[1] " "</code></pre>
<p>To compute a class, one need to decide a few input parameters: -
station infos, - landtype classification per distance from the station,
- max horizon derived from DEMs - and whether to use the “MET” or “WMO”
thresholds using <code>test_type</code>,</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Input</span></span>
<span><span class="va">land</span> <span class="op">&lt;-</span> <span class="va">landtype_dist</span></span>
<span><span class="va">horizon</span> <span class="op">&lt;-</span> <span class="va">horizon_max</span></span>
<span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="va">dem</span></span>
<span><span class="va">test_type</span> <span class="op">&lt;-</span> <span class="st">"MET"</span></span>
<span></span>
<span><span class="co"># Extract column and land type names</span></span>
<span><span class="va">colname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">land</span><span class="op">)</span></span>
<span><span class="va">landtype_name</span> <span class="op">&lt;-</span> <span class="va">colname</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>First the area percentage per landtype is computed and then converted
into a dataframe for extracting the zones required in the tests (i.e. 3,
5, 10, 30, 100m), including the two rings: 5-10 m and 10-30 m.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute area percentage per land type</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">land</span><span class="op">[</span>, <span class="va">colname</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">landtype_name</span><span class="op">]</span> <span class="op">/</span></span>
<span>  <span class="va">land</span><span class="op">[</span>, <span class="va">colname</span> <span class="op">==</span> <span class="st">"total_area"</span><span class="op">]</span> <span class="op">*</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># Reshape data.frame, equivalent to pivot_longer()</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>distance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ind</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      landtype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, <span class="va">landtype_name</span><span class="op">)</span>,</span>
<span>                      area <span class="op">=</span> <span class="va">values</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute area within an annular area 5-10m and 10-30m</span></span>
<span><span class="va">ring</span> <span class="op">&lt;-</span> <span class="va">land</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">land</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span>, <span class="va">colname</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">landtype_name</span><span class="op">]</span> <span class="op">-</span></span>
<span>  <span class="va">land</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">land</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, <span class="va">colname</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">landtype_name</span><span class="op">]</span></span>
<span><span class="va">ring_area</span> <span class="op">&lt;-</span> <span class="va">land</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">land</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span>, <span class="va">colname</span> <span class="op">==</span> <span class="st">"total_area"</span><span class="op">]</span> <span class="op">-</span></span>
<span>  <span class="va">land</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">land</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, <span class="va">colname</span> <span class="op">==</span> <span class="st">"total_area"</span><span class="op">]</span></span>
<span><span class="va">ring</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">ring</span> <span class="op">/</span> <span class="va">ring_area</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># Extract areas (%) at 3, 5, 5-10, 10, 10-30, 30, 100m radius for class tests</span></span>
<span><span class="va">df_radius</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">distance</span> <span class="op">==</span> <span class="fl">3</span>, <span class="st">"area"</span><span class="op">]</span>,</span>
<span>                         <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">distance</span> <span class="op">==</span> <span class="fl">5</span>, <span class="st">"area"</span><span class="op">]</span>,</span>
<span>                         <span class="va">ring</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">ring</span><span class="op">)</span> <span class="op">==</span> <span class="fl">10</span><span class="op">]</span>,</span>
<span>                         <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">distance</span> <span class="op">==</span> <span class="fl">10</span>, <span class="st">"area"</span><span class="op">]</span>,</span>
<span>                         <span class="va">ring</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">ring</span><span class="op">)</span> <span class="op">==</span> <span class="fl">30</span><span class="op">]</span>,</span>
<span>                         <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">distance</span> <span class="op">==</span> <span class="fl">30</span>, <span class="st">"area"</span><span class="op">]</span>,</span>
<span>                         <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">distance</span> <span class="op">==</span> <span class="fl">100</span>, <span class="st">"area"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign names for rows and columns</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df_radius</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">colname</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df_radius</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"3m"</span>, <span class="st">"5m"</span>, <span class="st">"5-10m"</span>, <span class="st">"10m"</span>, <span class="st">"10-30m"</span>, <span class="st">"30m"</span>, <span class="st">"100m"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_radius</span></span></code></pre></div>
<pre><code>         3m 5m 5-10m 10m 10-30m 30m 100m
building  0  0     0   0      0   0    7
road     25 18     5   8      6   6   21
water     0  0     0   0      0   0    0
grass    75 78    91  87     76  77   39
crop      0  4     1   2      2   2    4
bush      0  1     3   3     14  13   14
tree      0  0     0   0      2   2   16</code></pre>
</div>
<div class="section level4">
<h4 id="class-per-category">Class per category<a class="anchor" aria-label="anchor" href="#class-per-category"></a>
</h4>
<div class="section level5">
<h5 id="artificial-heat">Artificial heat<a class="anchor" aria-label="anchor" href="#artificial-heat"></a>
</h5>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1) Sum area percentages of building, road and water (1:3 rows) for each</span></span>
<span><span class="co"># distance (columns)</span></span>
<span><span class="va">landtypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">df_radius</span><span class="op">[</span><span class="va">colname</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span></span>
<span>                                 <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"building"</span>, <span class="st">"road"</span>, <span class="st">"water"</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">landtypes</span></span></code></pre></div>
<pre><code>    3m     5m  5-10m    10m 10-30m    30m   100m 
    25     18      5      8      6      6     28 </code></pre>
</div>
<div class="section level5">
<h5 id="vegetation">Vegetation<a class="anchor" aria-label="anchor" href="#vegetation"></a>
</h5>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 2) Sum grass to crop area and compute mean over distance classes</span></span>
<span><span class="va">vegetation</span>      <span class="op">&lt;-</span> <span class="va">df_radius</span><span class="op">[</span><span class="va">colname</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grass"</span>, <span class="st">"crop"</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">vegetation</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">vegetation</span><span class="op">)</span></span>
<span><span class="va">vegetation</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">vegetation</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">vegetation</span></span></code></pre></div>
<pre><code>grass  crop 
   75    77 </code></pre>
</div>
<div class="section level5">
<h5 id="shade">Shade<a class="anchor" aria-label="anchor" href="#shade"></a>
</h5>
<p>Shade algorithm was recently edited to account for narrow valleys and
assign a kinder class as one assumes that the station represents the
local environment within 1.5 km.</p>
<p>Otherwise it smoothes out the horizon with an hour time window.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 3) Projected shade limits</span></span>
<span><span class="va">height</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_horizon_rollmean.html">compute_horizon_rollmean</a></span><span class="op">(</span><span class="va">stn</span>, <span class="va">horizon</span><span class="op">)</span></span>
<span><span class="co"># Compute the percentage of terrain within 1500 m to assess if the station</span></span>
<span><span class="co"># is in a valley or an open terrain, the threshold being 66.666%</span></span>
<span><span class="va">range_valley</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">horizon</span><span class="op">[</span>, <span class="st">"range"</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">100</span> <span class="op">&amp;</span> <span class="va">horizon</span><span class="op">[</span>, <span class="st">"range"</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fl">1500</span><span class="op">)</span></span>
<span><span class="va">range_valley_tot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">range_valley</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">horizon</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">range_valley_tot</span> <span class="op">&lt;</span> <span class="fl">66.666</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># 3.1) if station is in an open terrain, compute the max of the horizon</span></span>
<span>  <span class="co"># (the default behaviour)</span></span>
<span>  <span class="va">shade</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>  <span class="co"># 3.2) if station is in a deep vally, set heights in the valley to 0 and</span></span>
<span>  <span class="co"># compute the mean to sill get an evaluation of the close environment</span></span>
<span>  <span class="va">height</span><span class="op">[</span><span class="va">range_valley</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">shade</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">shade</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"shade"</span></span>
<span><span class="va">shade</span></span></code></pre></div>
<pre><code><span>   <span class="va">shade</span> </span>
<span><span class="fl">53.50798</span> </span></code></pre>
</div>
<div class="section level5">
<h5 id="slope">Slope<a class="anchor" aria-label="anchor" href="#slope"></a>
</h5>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 4) Compute median slope</span></span>
<span><span class="va">slope</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/global.html" class="external-link">global</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/terrain.html" class="external-link">terrain</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span>,</span>
<span>                       \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.5</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">slope</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"slope"</span></span>
<span><span class="va">slope</span></span></code></pre></div>
<pre><code>         slope
slope 3.103583</code></pre>
</div>
</div>
<div class="section level4">
<h4 id="wmo-vs-met-class">WMO vs MET class<a class="anchor" aria-label="anchor" href="#wmo-vs-met-class"></a>
</h4>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set matrix of class test parameters</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">test_type</span> <span class="op">==</span> <span class="st">"WMO"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">class_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"class1"</span>, <span class="st">"class2"</span>, <span class="st">"class3"</span>, <span class="st">"class4"</span>, <span class="st">"class5"</span><span class="op">)</span></span>
<span>  <span class="va">type_names</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landtypes</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vegetation</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">shade</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">slope</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,  <span class="fl">1</span>,  <span class="fl">5</span>, <span class="cn">NA</span>, <span class="fl">10</span>, <span class="fl">51</span>,  <span class="fl">0</span>,  <span class="fl">5</span>, <span class="fl">19</span>,</span>
<span>                     <span class="cn">NA</span>, <span class="fl">1</span>,  <span class="fl">5</span>,  <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">10</span>, <span class="cn">NA</span>, <span class="fl">51</span>,  <span class="fl">0</span>,  <span class="fl">7</span>, <span class="fl">19</span>,</span>
<span>                     <span class="cn">NA</span>, <span class="fl">5</span>,  <span class="cn">NA</span>, <span class="fl">10</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">99</span>, <span class="fl">51</span>,  <span class="fl">7</span>, <span class="fl">99</span>,</span>
<span>                     <span class="fl">30</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">50</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">99</span>, <span class="fl">99</span>, <span class="fl">20</span>, <span class="fl">99</span>,</span>
<span>                     <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">99</span>, <span class="fl">99</span>, <span class="fl">99</span>, <span class="fl">99</span><span class="op">)</span>,</span>
<span>                   nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">class_names</span><span class="op">)</span>,</span>
<span>                   ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">type_names</span><span class="op">)</span>,</span>
<span>                   byrow <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">class_names</span>,</span>
<span>                                   <span class="va">type_names</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">test_type</span> <span class="op">==</span> <span class="st">"MET"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">class_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"class1"</span>, <span class="st">"class2"</span>, <span class="st">"class3"</span>, <span class="st">"class4"</span>, <span class="st">"class5"</span><span class="op">)</span></span>
<span>  <span class="va">type_names</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">landtypes</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vegetation</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">shade</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">slope</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,  <span class="fl">1</span>,  <span class="fl">5</span>, <span class="cn">NA</span>, <span class="fl">10</span>, <span class="fl">51</span>,  <span class="fl">0</span>,  <span class="fl">7</span>, <span class="fl">19</span>,</span>
<span>                     <span class="cn">NA</span>, <span class="fl">1</span>,  <span class="fl">5</span>,  <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">10</span>, <span class="cn">NA</span>, <span class="fl">51</span>,  <span class="fl">0</span>,  <span class="fl">7</span>, <span class="fl">19</span>,</span>
<span>                     <span class="cn">NA</span>, <span class="fl">5</span>,  <span class="cn">NA</span>, <span class="fl">10</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">99</span>, <span class="fl">51</span>,  <span class="fl">7</span>, <span class="fl">99</span>,</span>
<span>                     <span class="fl">30</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">50</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">99</span>, <span class="fl">51</span>, <span class="fl">20</span>, <span class="fl">99</span>,</span>
<span>                     <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">99</span>, <span class="fl">99</span>, <span class="fl">99</span>, <span class="fl">99</span><span class="op">)</span>,</span>
<span>                   nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">class_names</span><span class="op">)</span>,</span>
<span>                   ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">type_names</span><span class="op">)</span>,</span>
<span>                   byrow <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">class_names</span>,</span>
<span>                                   <span class="va">type_names</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">params</span></span></code></pre></div>
<pre><code>       3m 5m 5-10m 10m 10-30m 30m 100m grass crop shade slope
class1 NA NA    NA   1      5  NA   10    51    0     7    19
class2 NA  1     5  NA     NA  10   NA    51    0     7    19
class3 NA  5    NA  10     NA  NA   NA    99   51     7    99
class4 30 NA    NA  50     NA  NA   NA    99   51    20    99
class5 NA NA    NA  NA     NA  NA   NA    99   99    99    99</code></pre>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pierre-Marie Lefeuvre.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
